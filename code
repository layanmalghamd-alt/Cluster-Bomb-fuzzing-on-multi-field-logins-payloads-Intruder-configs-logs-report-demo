# Download DVWA

cd /var/www/html      # Download the DVWA project from GitHub into this directory
sudo git clone https://github.com/digininja/DVWA.git # Download the DVWA project from GitHub into this directory 
ls       # List files in the current directory to confirm DVWA was moved successfully
sudo chmod -R 777 DVWA      # Give full permissions to the DVWA folder
ls -l         # Verify permission changes and files again
cd DVWA       # Enter the DVWA project folder
cd config     # Enter the configuration folder for DVWA
cp config.inc.php.dist  config.inc.php    # Create the main DVWA config file from the sample template
sudo nano config.inc.php                  # Open the config file for editing in Nano, change db username and password to admin and password
sudo systemctl start mysql                # Start the MySQL database service
sudo systemctl status mysql               # Check if MySQL is running and active
sudo su                                   # Switch to the root user (administrator mode)
mysql -u root -p                          # Log in to MySQL as the root user
   
# Log in into MySQL
 Create Database For the DVWA
#inside mariadb write 
create user 'admin'@'127.0.0.1' identified by 'password';  -- Create a MySQL user "admin" 
grant all privileges on dvwa.* to 'admin'@'127.0.0.1';  -- Give the admin user full access to the dvwa database 
flush privileges; -- Apply changes to MySQL users and permissions
 exit

systemctl start apache2    # Start the Apache web server service
systemctl status apache2   # Check if Apache is running and active
cd /etc/php                # Go to the PHP configuration directory
ls                         # List available PHP versions installed on the system
cd 8.4                     # Enter the folder for PHP version 8.4 (choose the latest version you saw)
ls                         # List PHP configuration types for this version
cd apache2                 # Enter the PHP settings used specifically by Apache
ls                         # View the configuration files in this directory
sudo nano php.ini          # Open the php.ini file to edit PHP settings
#use ctrl f  search for fopen
#allow_url_fopen = On (make sure it’s on)
#allow_url_include = On (make sure it’s on)
#save the file with ctrl o
systemctl restart apache2 # Restart Apache to apply configuration changes
#Go to browser write URL 127.0.0.1/DVWA
#Login as admin and password
#Then create database

here is the code for the instlation and configuration of the modSecurity (WAF):


here is the custome rule file that i made for the modsecurity to block the attack:
File path: /etc/modsecurity/conf.d/zz_dvwa_bruteforce.conf

# zz_dvwa_bruteforce.conf - DVWA brute-force mitigation
SecAction "id:99000001,phase:1,pass,nolog,initcol:ip=%{REMOTE_ADDR}"

SecRule REQUEST_URI "@rx (?i)/DVWA/vulnerabilities/brute/?(\?.*)?$" \
  "phase:4,pass,id:99000010,log,chain,msg:'DVWA brute response checked'"
  SecRule RESPONSE_BODY "(?i:(login failed|incorrect|invalid|wrong password|username and/or password))" \
    "setvar:ip.dvwa_failures=+1,expirevar:ip.dvwa_failures=60"

SecRule IP:dvwa_failures "@gt 3" \
  "phase:1,deny,status:429,id:99000020,log,msg:'DVWA brute force - blocking IP %{REMOTE_ADDR} (fails=%{ip.dvwa_failures})'"

SecRule IP:dvwa_failures "@gt 3" \
  "phase:1,pass,id:99000021,log,append:'X-Blocked-By: ModSecurity DVWA'"

here are some important configuration i added for the modsecurity:
/etc/modsecurity/modsecurity.conf
SecRuleEngine DetectionOnly   # for test time it will be detection only now ; then set to On for blocking AFTER
SecRequestBodyAccess On
SecResponseBodyAccess On
SecResponseBodyLimit 524288
SecRequestBodyLimit 131072
SecAuditEngine RelevantOnly
SecAuditLog /var/log/apache2/modsec_audit.log

Set ModSecurity to detection only:
sudo sed -i 's/^SecRuleEngine.*/SecRuleEngine DetectionOnly/' /etc/modsecurity/modsecurity.conf
sudo systemctl restart apache2

Open these three terminals to capture evidence:
# Terminal A: Apache access log
sudo tail -f /var/log/apache2/access.log

# Terminal B: ModSecurity audit log
sudo tail -f /var/log/apache2/modsec_audit.log

# Terminal C: Apache error log
sudo tail -f /var/log/apache2/error.log

now in Burp, run your brute-force attack :
http://127.0.0.1/DVWA/vulnerabilities/brute/

now for the seconed part try with modsecurity enabled:
Enable blocking:
sudo sed -i 's/^SecRuleEngine.*/SecRuleEngine On/' /etc/modsecurity/modsecurity.conf
sudo systemctl restart apache2

